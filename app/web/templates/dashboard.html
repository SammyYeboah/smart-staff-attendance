{% extends "base.html" %}
{% block content %}
<section>
  <h2>Dashboard</h2>
  <div id="userInfo"></div>
  <hr>
  <h3>Clock In / Out</h3>
  <form id="clockInForm">
    <label>User ID</label>
    <input type="number" id="clockin_user_id" required>
    <button type="submit">Clock In</button>
  </form>
  <div id="clockInStatus" class="status"></div>

  <form id="clockOutForm" style="margin-top: 10px;">
    <label>User ID</label>
    <input type="number" id="clockout_user_id" required>
    <button type="submit">Clock Out</button>
  </form>
  <div id="clockOutStatus" class="status"></div>

  <hr>
  <h3>My Logs</h3>
  <div id="myLogs"></div>
</section>
<script>
(async function init() {
  const token = localStorage.getItem("token");
  if (!token) { window.location.href = "/web/login"; return; }

  const meRes = await fetch("/users/me", { headers: { "Authorization": "Bearer " + token } });
  const me = await meRes.json();
  if (!meRes.ok) { localStorage.removeItem("token"); window.location.href = "/web/login"; return; }
  document.getElementById("clockin_user_id").value = me.id;
  document.getElementById("clockout_user_id").value = me.id;
})();

async function getPosition() {
  return new Promise((resolve, reject) => {
    if (!navigator.geolocation) return reject(new Error("Geolocation not supported"));
    navigator.geolocation.getCurrentPosition(
      (pos) => resolve({ latitude: pos.coords.latitude, longitude: pos.coords.longitude }),
      (err) => reject(err),
      { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
    );
  });
}

document.getElementById("clockInForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const token = localStorage.getItem("token");
  try {
    const { latitude, longitude } = await getPosition();
    const payload = {
      user_id: parseInt(document.getElementById("clockin_user_id").value, 10),
      latitude, longitude
    };
    const res = await fetch("/attendance/clock-in", {
      method: "POST",
      headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    document.getElementById("clockInStatus").textContent =
      res.ok ? `Clocked in: entry #${data.attendance_id}` : (data.detail || "Clock-in failed.");
  } catch {
    document.getElementById("clockInStatus").textContent = "Enable GPS and try again.";
  }
});

document.getElementById("clockOutForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const token = localStorage.getItem("token");
  try {
    const { latitude, longitude } = await getPosition();
    const payload = {
      user_id: parseInt(document.getElementById("clockout_user_id").value, 10),
      latitude, longitude
    };
    const res = await fetch("/attendance/clock-out", {
      method: "POST",
      headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    document.getElementById("clockOutStatus").textContent =
      res.ok ? `Clocked out: entry #${data.attendance_id}` : (data.detail || "Clock-out failed.");
  } catch {
    document.getElementById("clockOutStatus").textContent = "Enable GPS and try again.";
  }
});
</script>
{% endblock %}
